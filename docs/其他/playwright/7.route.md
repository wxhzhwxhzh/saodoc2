---
id: intro7
permalink: /pw/intro7
title: 'ğŸ’œpage.route()'
---


 **Playwrightï¼ˆPythonï¼‰é‡Œ `page.route`** çš„æ¦‚å¿µã€APIã€å¸¸è§ç”¨æ³•ã€æ³¨æ„äº‹é¡¹å’Œå¯å¤ç”¨çš„åŒæ­¥/å¼‚æ­¥ç¤ºä¾‹

# æ¦‚è§ˆï¼ˆä¸€å¥è¯ï¼‰

`page.route(pattern, handler)` ç”¨æ¥æ‹¦æˆªé¡µé¢å‘å‡ºçš„ç½‘ç»œè¯·æ±‚ï¼ˆXHRã€fetchã€å›¾ç‰‡ã€è„šæœ¬ç­‰ï¼‰ï¼ŒæŠŠè¯·æ±‚äº¤ç»™ä½ å†™çš„ `handler(route, request)` æ¥å†³å®šï¼š**ç»§ç»­å‘é€ / ä¿®æ”¹åå‘é€ / ç›´æ¥è¿”å›å‡æ•°æ® / ä¸­æ­¢è¯·æ±‚**ã€‚ä¸€æ—¦å¯ç”¨åŒ¹é…çš„è·¯ç”±ï¼Œè¯·æ±‚ä¼šè¢«â€œæŒ‚èµ·â€ï¼Œç›´åˆ°ä½ ç”¨ `route.continue_()` / `route.fulfill()` / `route.abort()` / `route.fallback()` ä¹‹ä¸€å¤„ç†å®ƒã€‚ ([playwright.dev][1])

---

# åŸºæœ¬æ¦‚å¿µä¸ç­¾å

* æ³¨å†Œè·¯ç”±ï¼ˆåŒæ­¥ APIï¼‰ï¼š

```py
page.route("**/api/**", handler)   # handler(route, request)
```

* æ³¨å†Œè·¯ç”±ï¼ˆå¼‚æ­¥ APIï¼‰é€šå¸¸å†™æ³•ï¼ˆä¹Ÿå¯ç›´æ¥ä¸ awaitï¼Œå®˜æ–¹ç¤ºä¾‹æœ‰ await çš„å†™æ³•ï¼‰ï¼š

```py
await page.route("**/api/**", handler)   # async def handler(route, request)
```

* handler çš„ä¸¤ä¸ªå‚æ•°ï¼š`route`ï¼ˆRoute å¯¹è±¡ï¼Œç”¨æ¥æ“ä½œè¯·æ±‚ï¼‰å’Œ `request`ï¼ˆRequest å¯¹è±¡ï¼Œç”¨æ¥è¯»å–åŸå§‹è¯·æ±‚ä¿¡æ¯ï¼Œä¾‹å¦‚ `request.url`, `request.method`, `request.post_data` ç­‰ï¼‰ã€‚ ([playwright.dev][1])

---

# Route å¸¸ç”¨æ–¹æ³•ï¼ˆé€ŸæŸ¥ï¼‰

* `route.continue_(**overrides)`ï¼šæŠŠè¯·æ±‚å‘åˆ°ç½‘ç»œï¼Œå¯ä»¥ç”¨ `headers`, `method`, `post_data`, `url` ç­‰è¦†ç›–ï¼ˆæ³¨æ„ `continue_` åœ¨ Python ä¸­æ˜¯ `continue_`ï¼Œå› ä¸º `continue` æ˜¯å…³é”®å­—ï¼‰ã€‚**ä½¿ç”¨ `continue_` æ—¶ï¼Œå…¶ä»–å·²æ³¨å†Œçš„åŒ¹é…å¤„ç†å™¨ä¸ä¼šå†è¢«è°ƒç”¨**ï¼ˆç«‹å³å‘é€ï¼‰ã€‚ ([playwright.dev][2])
* `route.fallback(**overrides)`ï¼šä¸ `continue_` ç±»ä¼¼ï¼Œä½†ä¼šæŠŠè¯·æ±‚â€œä¼ é€’åˆ°ä¸‹ä¸€ä¸ªåŒ¹é…çš„ handlerâ€ï¼Œå³å…è®¸é“¾å¼/å±‚å çš„å¤„ç†å™¨åä½œï¼ˆintroduced v1.23ï¼‰ã€‚ ([playwright.dev][2])
* `route.fulfill(status=..., body=..., content_type=..., headers=..., path=..., response=..., json=...)`ï¼šç›´æ¥ç”¨ä½ æŒ‡å®šçš„å“åº”æ¥â€œå®Œæˆâ€è¯·æ±‚ï¼ˆmock å“åº”ï¼‰ã€‚å¯ä»¥ç›´æ¥ä»¥ `body`/`path`/æˆ– `response`ï¼ˆæ¥è‡ª `route.fetch()`ï¼‰ä½œä¸ºåŸºç¡€å¹¶åšä¿®æ”¹ã€‚ ([playwright.dev][3])
* `route.abort(error_code=None)`ï¼šä¸­æ­¢è¯·æ±‚ï¼ˆé»˜è®¤ `failed`ï¼Œä¹Ÿå¯ä»¥ä¼ ç‰¹å®šé”™è¯¯ç ï¼‰ã€‚ ([playwright.dev][2])
* `route.fetch()`ï¼šä»ç½‘ç»œæ‰§è¡ŒåŸå§‹è¯·æ±‚å¹¶è¿”å› `Response` å¯¹è±¡ï¼ˆä¾¿äºåŸºäºçœŸå®å“åº”åšä¿®æ”¹åå† `fulfill`ï¼‰ã€‚ ([playwright.dev][4])

---

# åŒ¹é…è§„åˆ™ã€ä¼˜å…ˆçº§ä¸å–æ¶ˆè·¯ç”±

* `url` å‚æ•°å¯ä»¥æ˜¯ globï¼ˆ`**/*`ï¼‰ã€æ­£åˆ™æˆ–å›è°ƒ predicateï¼ˆæ¥æ”¶ URL åˆ¤æ–­ï¼‰ï¼Œéå¸¸çµæ´»ã€‚ ([playwright.dev][5])
* **ä¼˜å…ˆçº§**ï¼š`page.route`ï¼ˆåªå¯¹è¯¥ pageï¼‰æ¯” `browser_context.route` æ›´é«˜ï¼ˆå³åŒä¸€è¯·æ±‚åŒæ—¶åŒ¹é… page å’Œ context çš„è§„åˆ™æ—¶ï¼Œpage çš„ handler ä¼˜å…ˆï¼‰ã€‚è¦å¯¹æ‰€æœ‰é¡µé¢ï¼ˆåŒ…æ‹¬ popupï¼‰æ‹¦æˆªï¼Œè€ƒè™‘ç”¨ `context.route`ã€‚ ([playwright.dev][5])
* å–æ¶ˆè·¯ç”±ï¼š`page.unroute(url[, handler])` â€”â€” å¦‚æœä¸ä¼  handlerï¼Œä¼šç§»é™¤åŒ¹é… URL çš„æ‰€æœ‰è·¯ç”±ã€‚ ([playwright.dev][1])

---

# å®æˆ˜ç¤ºä¾‹ï¼ˆå¯ç›´æ¥å¤åˆ¶ç²˜è´´æ”¹é€ ï¼‰

## 1) åŒæ­¥ APIï¼šæ‹¦æˆªå¹¶ mock æŸä¸ª API

```py
from playwright.sync_api import sync_playwright
import json

def run():
    with sync_playwright() as pw:
        browser = pw.chromium.launch()
        page = browser.new_page()

        def handler(route, request):
            if "api.example.com/data" in request.url:
                body = json.dumps({"mocked": True, "data": []})
                route.fulfill(status=200, content_type="application/json", body=body)
            else:
                route.continue_()   # ä¸€å®šè¦å¤„ç†ï¼Œå¦åˆ™è¯·æ±‚ä¼šæŒ‚èµ·

        page.route("**/api/**", handler)
        page.goto("https://example.com")
        browser.close()

if __name__ == "__main__":
    run()
```

## 2) å¼‚æ­¥ APIï¼šåŸºäºçœŸå®å“åº”ä¿®æ”¹å¹¶è¿”å›ï¼ˆfetch â†’ æ”¹ json â†’ fulfillï¼‰

```py
import asyncio
from playwright.async_api import async_playwright

async def run():
    async with async_playwright() as pw:
        browser = await pw.chromium.launch()
        context = await browser.new_context()
        page = await context.new_page()

        async def handler(route, request):
            if "/xhr_endpoint" in request.url:
                # è¯·æ±‚åŸå§‹æ•°æ®ï¼Œç„¶ååœ¨è¿”å›å†…å®¹ä¸Šæ‰“è¡¥ä¸
                response = await route.fetch()
                data = await response.json()
                data["injected_by_test"] = True
                await route.fulfill(response=response, json=data)
            else:
                await route.continue_()

        await page.route("**/xhr_endpoint", handler)
        await page.goto("https://example.com")
        await browser.close()

asyncio.run(run())
```
## 3) åŒæ­¥ APIï¼šåŸºäºçœŸå®å“åº”ä¿®æ”¹å¹¶è¿”å›ï¼ˆfetch â†’ æ”¹ json â†’ fulfillï¼‰

```py
from playwright.sync_api import sync_playwright

def run():
    with sync_playwright() as pw:
        browser = pw.chromium.launch()
        page = browser.new_page()

        def handler(route, request):
            if "/xhr_endpoint" in request.url:
                response = route.fetch()
                data = response.json()
                data["patched_by_test"] = True
                route.fulfill(response=response, json=data)
            else:
                route.continue_()

        page.route("**/xhr_endpoint", handler)
        page.goto("https://example.com")
        browser.close()

if __name__ == "__main__":
    run()
```


ï¼ˆä¸Šé¢ `route.fetch()` + `route.fulfill(response=..., json=...)` æ˜¯å®˜æ–¹æ¨èç”¨æ³•ï¼Œç”¨äºâ€œåœ¨çœŸå®å“åº”åŸºç¡€ä¸Šåšå°æ”¹åŠ¨å†è¿”å›â€ã€‚ï¼‰ ([playwright.dev][4])

---

# å¸¸è§åœºæ™¯ä¸å°æŠ€å·§

* **åªæ‹¦æˆªä½ å…³å¿ƒçš„ URL åŒºé—´**ï¼ˆæ¯”å¦‚ `**/api/**`ï¼‰ï¼Œé¿å…ç”¨ `**/*` å…¨æ‹¦æˆªï¼Œæ€§èƒ½å’Œè°ƒè¯•éƒ½ä¼šæ›´å‹å¥½ã€‚
* **æ¨¡æ‹Ÿæ…¢ç½‘é€Ÿ / è¶…æ—¶**ï¼šå¯ä»¥ `time.sleep`ï¼ˆåŒæ­¥ï¼‰æˆ– `await asyncio.sleep`ï¼ˆå¼‚æ­¥ï¼‰å `fulfill()` æ¥æ¨¡æ‹Ÿå»¶è¿Ÿï¼Œæˆ– `abort("timedout")`ã€‚
* **ä¿®æ”¹è¯·æ±‚å¤´ / body**ï¼šåœ¨ `route.continue_(headers=..., method=..., post_data=..., url=...)` é‡Œè¦†ç›–ã€‚æ³¨æ„ï¼šheaders ä¼šä½œç”¨åˆ°é‡å®šå‘çš„è¯·æ±‚ï¼Œä½† `url/method/post_data` çš„è¦†ç›–åªåº”ç”¨åˆ°åŸå§‹è¯·æ±‚ï¼Œä¸ä¼šè‡ªåŠ¨ä¼ é€’åˆ°é‡å®šå‘åçš„è¯·æ±‚ã€‚ ([playwright.dev][3])
* **å±‚å è·¯ç”±ï¼ˆfallbackï¼‰**ï¼šç”¨ `route.fallback()` å¯ä»¥è®©å¤šä¸ª handler ä¸²è”ï¼Œæœ€åä¸€ä¸ª handler å†³å®šæœ€ç»ˆè¡Œä¸ºï¼›è€Œ `continue_()` åˆ™ä¼šç«‹å³æŠŠè¯·æ±‚å‘å‡ºå¹¶è·³è¿‡åç»­ handlerã€‚ ([playwright.dev][2])
* **ä¸è¦å¿˜äº†æ‰€æœ‰åˆ†æ”¯éƒ½å¤„ç†**ï¼šå¦‚æœ handler åœ¨æŸäº›åˆ†æ”¯æ—¢æ²¡ `continue_()`ã€ä¹Ÿæ²¡ `fulfill()` / `abort()`ï¼Œå¯¹åº”è¯·æ±‚ä¼šä¸€ç›´æŒ‚èµ·ï¼Œå¯¼è‡´é¡µé¢æ“ä½œå¡ä½ï¼ˆéå¸¸å¸¸è§çš„é™·é˜±ï¼‰ã€‚ ([playwright.dev][1])

---

# æ³¨æ„äº‹é¡¹ / å¸¸è§å‘

* **å¯ç”¨è·¯ç”±ä¼šç¦ç”¨ HTTP ç¼“å­˜**ï¼ˆæ–‡æ¡£æœ‰æ˜ç¡®è¯´æ˜ï¼‰ï¼Œæµ‹è¯•æ—¶å¯èƒ½å› æ­¤çœ‹åˆ°ä¸åŒçš„è¡Œä¸ºã€‚ ([playwright.dev][5])
* `continue_()` ä¸èƒ½è¦†ç›– `Cookie` headerï¼ˆæµè§ˆå™¨ä¼šä» cookie store åŠ è½½ï¼‰ï¼Œå¦‚æœä½ éœ€è¦è‡ªå®šä¹‰ cookieï¼Œè¯·ç”¨ `context.add_cookies()` æˆ–å…¶ä»–åŠæ³•ã€‚ ï¼ˆæ–‡æ¡£å’Œå®ç°é‡Œæåˆ° Cookie è¦†ç›–æ˜¯å—é™çš„ï¼‰ ([playwright-ruby-client.vercel.app][6])
* å½“å¤šä¸ª route pattern åŒ¹é…æ—¶ï¼Œæ‰§è¡Œé¡ºåº**æ˜¯æ³¨å†Œé¡ºåºçš„åå‘**ï¼ˆæœ€åæ³¨å†Œçš„å…ˆæ‰§è¡Œï¼‰ï¼Œè¿™è®©â€œè¦†ç›–é»˜è®¤è·¯ç”±â€çš„æ¨¡å¼å¾ˆæ–¹ä¾¿ï¼Œä½†ä¹Ÿè¦ç•™æ„é¡ºåºã€‚ ([Cuketest][7])

---

# å°å‹ cheatsheetï¼ˆè°ƒç”¨æ ¼å¼ï¼‰

* æ³¨å†Œï¼š`page.route(url, handler)` æˆ– `context.route(url, handler)`ã€‚ ([playwright.dev][1])
* å¤„ç†ï¼š`route.continue_(headers=..., url=..., method=..., post_data=...)`ã€‚ ([playwright.dev][3])
* mockï¼š`route.fulfill(status=200, content_type='application/json', body=json.dumps(...))` æˆ– `route.fulfill(response=response, json=...)`ã€‚ ([playwright.dev][3])
* ä¸­æ­¢ï¼š`route.abort()`ã€‚ ([playwright.dev][2])
* åŸå§‹è¯·æ±‚ï¼š`response = await route.fetch()`ã€‚ ([playwright.dev][4])
* å–æ¶ˆè·¯ç”±ï¼š`page.unroute(url[, handler])`ã€‚ ([playwright.dev][1])

---


## 4.å®æˆ˜ä»£ç ç¤ºä¾‹1
```python
from playwright.sync_api import sync_playwright,Request,Response,Route
import json
    # å­˜å‚¨æ‰€æœ‰JSONå“åº”çš„åˆ—è¡¨
json_responses = []

def handle_route(route:Route, request:Request):
    if request.resource_type == "image":
        # æ‹¦æˆªå›¾ç‰‡è¯·æ±‚ï¼Œ
        route.continue_(url="https://wxhzhwxhzh.github.io/sao/fav2.png")
    else:
        # ç»§ç»­å¤„ç†å…¶ä»–è¯·æ±‚
        route.continue_()

       
def handle_route2(route):
    # æŠ“å–åå°jsonæ•°æ®åŒ…
    response = route.fetch()    
    # æ£€æŸ¥å“åº”æ˜¯å¦ä¸ºJSONç±»å‹
    content_type = response.headers.get("content-type", "")
    if "/json" in content_type:
        try:
            # è§£æJSONæ•°æ®
            json_data = response.json()          
            # æ‰“å°æ•è·åˆ°çš„JSONä¿¡æ¯
            print(f"\næ•è·åˆ°JSONå“åº”: {response.url} (çŠ¶æ€ç : {response.status})")
            print("JSONæ•°æ®:")
            print(json_data)
        except Exception as e:
            print(f"è§£æJSONå¤±è´¥ {response.url}: {str(e)}")
    
    # ç»§ç»­åŸå§‹å“åº”
    route.continue_()


def handle_route3(route:Route, request:Request):
    # æ‹¦æˆªå¹¶ç¯¡æ”¹ç½‘é¡µåŸç”Ÿjsçš„å†…å®¹
    if "head.js" in request.url:
        response:Response = route.fetch()
        old_str = "window.Douban = "
        new_str = "console.log('éªšç¥çœŸå¸…ï¼ï¼ï¼ï¼ï¼ï¼');"
        data = response.text().replace(old_str, new_str+old_str)
        print(data)
        body_bytes = data.encode("utf-8")        
        route.fulfill(headers=response.headers, status=response.status, body=body_bytes)
    else:
        route.continue_()    

def main():
    with sync_playwright() as p:
        # å¯åŠ¨æµè§ˆå™¨ï¼ˆé»˜è®¤ä¸º Chromiumï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨ p.firefox æˆ– p.webkitï¼‰
        browser = p.chromium.launch(headless=False)  # headless=False è¡¨ç¤ºæ˜¾ç¤ºæµè§ˆå™¨çª—å£
        page = browser.new_page()
        page.route("**/*", handle_route3)  # æ‹¦æˆªæ‰€æœ‰è¯·æ±‚
        
        # æ‰“å¼€è±†ç“£é¦–é¡µ
        page.goto("https://www.douban.com")
        
       
        page.wait_for_timeout(3000)  # ç­‰å¾…3ç§’ï¼ˆ
        
        # æ‰“å°é¡µé¢æ ‡é¢˜
        print("é¡µé¢æ ‡é¢˜:", page.title())
        
        # å…³é—­æµè§ˆå™¨
        browser.close()

if __name__ == "__main__":
    main()
```