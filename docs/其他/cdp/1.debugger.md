---
id: intro1
permalink: /cdp/p1
title: 'ğŸŸ Debugger æ•™ç¨‹'
---

# ğŸŸ CDP Debugger å…¥é—¨æ•™ç¨‹

```python

import json
import websocket
import requests
import time

def get_websocket_url(port=9222):
    """è·å– WebSocket è°ƒè¯• URL"""
    response = requests.get(f'http://localhost:{port}/json')
    tabs = response.json()
    return tabs[0]['webSocketDebuggerUrl']

class CDPDebugger:
    """CDP è°ƒè¯•å™¨å°è£…ç±»"""
    
    def __init__(self, ws_url):
        self.ws = websocket.create_connection(ws_url)
        self.command_id = 0
        
    def send_command(self, method, params=None):
        """å‘é€ CDP å‘½ä»¤"""
        self.command_id += 1
        command = {
            "id": self.command_id,
            "method": method,
            "params": params or {}
        }
        print(f"\n>>> å‘é€å‘½ä»¤: {method}")
        print(f"    å‚æ•°: {json.dumps(params or {}, indent=6)}")
        
        self.ws.send(json.dumps(command))
        response = json.loads(self.ws.recv())
        
        print(f"<<< å“åº”: {json.dumps(response, indent=4, ensure_ascii=False)}")
        return response
    
    def wait_for_event(self, event_name, timeout=5):
        """ç­‰å¾…ç‰¹å®šäº‹ä»¶"""
        print(f"\n--- ç­‰å¾…äº‹ä»¶: {event_name} ---")
        start_time = time.time()
        
        while time.time() - start_time < timeout:
            try:
                self.ws.settimeout(1)
                message = self.ws.recv()
                data = json.loads(message)
                
                if 'method' in data:
                    print(f"    æ”¶åˆ°äº‹ä»¶: {data['method']}")
                    if data['method'] == event_name:
                        print(f"    äº‹ä»¶è¯¦æƒ…: {json.dumps(data['params'], indent=8, ensure_ascii=False)}")
                        return data
            except:
                continue
        
        print(f"    è¶…æ—¶: æœªæ”¶åˆ° {event_name} äº‹ä»¶")
        return None
    
    def close(self):
        self.ws.close()


# ========================================
# ç¤ºä¾‹ 1: åŸºç¡€è°ƒè¯•æµç¨‹
# ========================================
def example_basic_debugging():
    """
    æ¼”ç¤ºåŸºç¡€è°ƒè¯•å‘½ä»¤ç»„åˆ:
    1. Debugger.enable - å¯ç”¨è°ƒè¯•å™¨
    2. Runtime.enable - å¯ç”¨è¿è¡Œæ—¶
    3. Page.enable - å¯ç”¨é¡µé¢äº‹ä»¶
    4. Page.navigate - å¯¼èˆªåˆ°é¡µé¢
    """
    print("\n" + "="*60)
    print("ç¤ºä¾‹ 1: åŸºç¡€è°ƒè¯•æµç¨‹")
    print("="*60)
    
    debugger = CDPDebugger(get_websocket_url())
    
    # 1. å¯ç”¨è°ƒè¯•å™¨
    debugger.send_command("Debugger.enable")
    
    # 2. å¯ç”¨è¿è¡Œæ—¶ï¼ˆç”¨äºæ‰§è¡Œ JavaScriptï¼‰
    debugger.send_command("Runtime.enable")
    
    # 3. å¯ç”¨é¡µé¢äº‹ä»¶
    debugger.send_command("Page.enable")
    
    # 4. å¯¼èˆªåˆ°é¡µé¢
    debugger.send_command("Page.navigate", {
        "url": "https://example.com"
    })
    
    # ç­‰å¾…é¡µé¢åŠ è½½äº‹ä»¶
    debugger.wait_for_event("Page.loadEventFired")
    
    debugger.close()


# ========================================
# ç¤ºä¾‹ 2: è®¾ç½®æ–­ç‚¹å’Œæš‚åœ
# ========================================
def example_breakpoints():
    """
    æ¼”ç¤ºæ–­ç‚¹ç›¸å…³å‘½ä»¤:
    1. Debugger.setBreakpointByUrl - æŒ‰ URL è®¾ç½®æ–­ç‚¹
    2. Debugger.pause - æš‚åœæ‰§è¡Œ
    3. Debugger.resume - æ¢å¤æ‰§è¡Œ
    4. Debugger.stepOver - å•æ­¥è·³è¿‡
    5. Debugger.stepInto - å•æ­¥è¿›å…¥
    6. Debugger.stepOut - å•æ­¥è·³å‡º
    """
    print("\n" + "="*60)
    print("ç¤ºä¾‹ 2: æ–­ç‚¹å’Œå•æ­¥è°ƒè¯•")
    print("="*60)
    
    debugger = CDPDebugger(get_websocket_url())
    
    debugger.send_command("Debugger.enable")
    debugger.send_command("Runtime.enable")
    
    # 1. æŒ‰ URL è®¾ç½®æ–­ç‚¹
    debugger.send_command("Debugger.setBreakpointByUrl", {
        "lineNumber": 10,
        "url": "https://example.com/script.js",
        "columnNumber": 0,
        "condition": "x > 5"  # æ¡ä»¶æ–­ç‚¹
    })
    
    # 2. æš‚åœæ‰€æœ‰æ‰§è¡Œ
    debugger.send_command("Debugger.pause")
    
    # ç­‰å¾…æš‚åœäº‹ä»¶
    paused_event = debugger.wait_for_event("Debugger.paused")
    
    if paused_event:
        # 3. å•æ­¥è·³è¿‡
        debugger.send_command("Debugger.stepOver")
        
        # 4. å•æ­¥è¿›å…¥å‡½æ•°
        debugger.send_command("Debugger.stepInto")
        
        # 5. å•æ­¥è·³å‡ºå‡½æ•°
        debugger.send_command("Debugger.stepOut")
        
        # 6. æ¢å¤æ‰§è¡Œ
        debugger.send_command("Debugger.resume")
    
    debugger.close()


# ========================================
# ç¤ºä¾‹ 3: æ‰§è¡Œ JavaScript å’Œè·å–è°ƒç”¨æ ˆ
# ========================================
def example_runtime_evaluation():
    """
    æ¼”ç¤ºè¿è¡Œæ—¶è¯„ä¼°å‘½ä»¤:
    1. Runtime.evaluate - æ‰§è¡Œ JavaScript
    2. Debugger.evaluateOnCallFrame - åœ¨è°ƒç”¨å¸§ä¸Šè¯„ä¼°
    3. Runtime.getProperties - è·å–å¯¹è±¡å±æ€§
    """
    print("\n" + "="*60)
    print("ç¤ºä¾‹ 3: JavaScript æ‰§è¡Œå’Œè¯„ä¼°")
    print("="*60)
    
    debugger = CDPDebugger(get_websocket_url())
    
    debugger.send_command("Debugger.enable")
    debugger.send_command("Runtime.enable")
    
    # 1. åœ¨é¡µé¢ä¸Šä¸‹æ–‡ä¸­æ‰§è¡Œ JavaScript
    result = debugger.send_command("Runtime.evaluate", {
        "expression": "document.title",
        "returnByValue": True
    })
    
    # 2. æ‰§è¡Œæ›´å¤æ‚çš„è¡¨è¾¾å¼
    debugger.send_command("Runtime.evaluate", {
        "expression": """
            (function() {
                return {
                    url: window.location.href,
                    userAgent: navigator.userAgent,
                    screenWidth: screen.width
                };
            })()
        """,
        "returnByValue": True
    })
    
    # 3. è·å–å…¨å±€å¯¹è±¡
    result = debugger.send_command("Runtime.evaluate", {
        "expression": "window",
        "returnByValue": False
    })
    
    if 'result' in result and 'result' in result['result']:
        object_id = result['result']['result'].get('objectId')
        if object_id:
            # 4. è·å–å¯¹è±¡çš„å±æ€§
            debugger.send_command("Runtime.getProperties", {
                "objectId": object_id,
                "ownProperties": True
            })
    
    debugger.close()


# ========================================
# ç¤ºä¾‹ 4: è„šæœ¬ç®¡ç†
# ========================================
def example_script_management():
    """
    æ¼”ç¤ºè„šæœ¬ç›¸å…³å‘½ä»¤:
    1. Debugger.getScriptSource - è·å–è„šæœ¬æºä»£ç 
    2. Debugger.setScriptSource - çƒ­æ›´æ–°è„šæœ¬ï¼ˆå®éªŒæ€§ï¼‰
    3. Debugger.searchInContent - åœ¨è„šæœ¬ä¸­æœç´¢
    """
    print("\n" + "="*60)
    print("ç¤ºä¾‹ 4: è„šæœ¬ç®¡ç†")
    print("="*60)
    
    debugger = CDPDebugger(get_websocket_url())
    
    debugger.send_command("Debugger.enable")
    
    # ç­‰å¾…è„šæœ¬è§£æäº‹ä»¶
    script_event = debugger.wait_for_event("Debugger.scriptParsed", timeout=3)
    
    if script_event and 'params' in script_event:
        script_id = script_event['params'].get('scriptId')
        
        if script_id:
            # 1. è·å–è„šæœ¬æºä»£ç 
            debugger.send_command("Debugger.getScriptSource", {
                "scriptId": script_id
            })
            
            # 2. åœ¨è„šæœ¬ä¸­æœç´¢
            debugger.send_command("Debugger.searchInContent", {
                "scriptId": script_id,
                "query": "function",
                "caseSensitive": False,
                "isRegex": False
            })
    
    debugger.close()


# ========================================
# ç¤ºä¾‹ 5: å¼‚å¸¸å¤„ç†
# ========================================
def example_exception_handling():
    """
    æ¼”ç¤ºå¼‚å¸¸å¤„ç†å‘½ä»¤:
    1. Debugger.setPauseOnExceptions - è®¾ç½®å¼‚å¸¸æ—¶æš‚åœ
    2. Debugger.setAsyncCallStackDepth - è®¾ç½®å¼‚æ­¥è°ƒç”¨æ ˆæ·±åº¦
    """
    print("\n" + "="*60)
    print("ç¤ºä¾‹ 5: å¼‚å¸¸å¤„ç†")
    print("="*60)
    
    debugger = CDPDebugger(get_websocket_url())
    
    debugger.send_command("Debugger.enable")
    debugger.send_command("Runtime.enable")
    
    # 1. è®¾ç½®åœ¨æ‰€æœ‰å¼‚å¸¸æ—¶æš‚åœ
    debugger.send_command("Debugger.setPauseOnExceptions", {
        "state": "all"  # å¯é€‰å€¼: "none", "uncaught", "all"
    })
    
    # 2. è®¾ç½®å¼‚æ­¥è°ƒç”¨æ ˆæ·±åº¦
    debugger.send_command("Debugger.setAsyncCallStackDepth", {
        "maxDepth": 32
    })
    
    # 3. æ‰§è¡Œä¼šæŠ›å‡ºå¼‚å¸¸çš„ä»£ç 
    debugger.send_command("Runtime.evaluate", {
        "expression": "throw new Error('æµ‹è¯•å¼‚å¸¸')",
        "returnByValue": True
    })
    
    # ç­‰å¾…å¼‚å¸¸æš‚åœ
    debugger.wait_for_event("Debugger.paused")
    
    debugger.close()


# ========================================
# ç¤ºä¾‹ 6: ç»¼åˆåº”ç”¨ - æ€§èƒ½åˆ†æ
# ========================================
def example_performance_profiling():
    """
    æ¼”ç¤ºæ€§èƒ½åˆ†æç»„åˆ:
    1. Profiler.enable - å¯ç”¨æ€§èƒ½åˆ†æå™¨
    2. Profiler.start - å¼€å§‹è®°å½•
    3. Profiler.stop - åœæ­¢è®°å½•
    4. Coverage.enable - å¯ç”¨ä»£ç è¦†ç›–ç‡
    """
    print("\n" + "="*60)
    print("ç¤ºä¾‹ 6: æ€§èƒ½åˆ†æ")
    print("="*60)
    
    debugger = CDPDebugger(get_websocket_url())
    
    debugger.send_command("Debugger.enable")
    debugger.send_command("Profiler.enable")
    
    # 1. å¼€å§‹æ€§èƒ½åˆ†æ
    debugger.send_command("Profiler.start")
    
    # 2. æ‰§è¡Œä¸€äº›ä»£ç 
    debugger.send_command("Runtime.evaluate", {
        "expression": """
            for(let i = 0; i < 1000000; i++) {
                Math.sqrt(i);
            }
        """
    })
    
    # 3. åœæ­¢æ€§èƒ½åˆ†æå¹¶è·å–ç»“æœ
    profile = debugger.send_command("Profiler.stop")
    
    # 4. å¯ç”¨ä»£ç è¦†ç›–ç‡
    debugger.send_command("Profiler.startPreciseCoverage", {
        "callCount": True,
        "detailed": True
    })
    
    time.sleep(2)
    
    # 5. è·å–è¦†ç›–ç‡æ•°æ®
    debugger.send_command("Profiler.takePreciseCoverage")
    
    debugger.close()


# ========================================
# ä¸»å‡½æ•° - è¿è¡Œæ‰€æœ‰ç¤ºä¾‹
# ========================================
if __name__ == "__main__":
    print("\n" + "="*60)
    print("CDP Debugger å¸¸ç”¨å‘½ä»¤ç¤ºä¾‹é›†")
    print("="*60)
    print("\nè¯·ç¡®ä¿ Chrome å·²ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤å¯åŠ¨:")
    print("chrome --remote-debugging-port=9222 --user-data-dir=/tmp/chrome-debug")
    print("\n")
    
    try:
        # è¿è¡Œæ‰€æœ‰ç¤ºä¾‹
        example_basic_debugging()
        time.sleep(1)
        
        example_breakpoints()
        time.sleep(1)
        
        example_runtime_evaluation()
        time.sleep(1)
        
        example_script_management()
        time.sleep(1)
        
        example_exception_handling()
        time.sleep(1)
        
        example_performance_profiling()
        
        print("\n" + "="*60)
        print("æ‰€æœ‰ç¤ºä¾‹æ‰§è¡Œå®Œæˆï¼")
        print("="*60)
        
    except requests.exceptions.ConnectionError:
        print("\nâŒ é”™è¯¯: æ— æ³•è¿æ¥åˆ° Chrome")
        print("è¯·ç¡®ä¿ Chrome å·²ä½¿ç”¨ --remote-debugging-port=9222 å¯åŠ¨")
    except Exception as e:
        print(f"\nâŒ å‘ç”Ÿé”™è¯¯: {e}")
        import traceback
        traceback.print_exc()


```